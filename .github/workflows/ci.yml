name: CI - Master Orchestrator


on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Nightly integration test
    - cron: "0 2 * * *"


env:
  CARGO_TERM_COLOR: always
  SEKHA_PORT: 8080
  CHROMA_HOST: http://localhost:8000
  OLLAMA_HOST: http://localhost:11434
  REDIS_HOST: redis://localhost:6379/0
  SEKHA_API_KEY: "test-token-123-456-789"  # Test-only token - never use in production
  OLLAMA_MODELS: "nomic-embed-text:latest,llama3.1:8b"


jobs:
  # ============================================================
  # PHASE 1: Test Controller
  # ============================================================
  test-controller:
    name: Test Sekha Controller
    runs-on: ubuntu-latest
    services:
      chroma:
        image: chromadb/chroma:latest
        ports:
          - 8000:8000
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features

      - name: Build
        run: cargo build --all-features --verbose

      - name: Run unit tests
        run: cargo test --lib --all-features --verbose

      - name: Run integration tests
        run: cargo test --test integration --all-features --verbose

      - name: Run API tests
        run: cargo test --test api_test --all-features --verbose

      - name: Run 1M message benchmark
        run: cargo test --release --test benchmark -- --nocapture
        timeout-minutes: 15

      - name: Run E2E smoke test
        run: ./tests/e2e/smoke_test.sh
        env:
          SEKHA_API_KEY: ${{ env.SEKHA_API_KEY }}
          SEKHA_BASE_URL: http://localhost:${{ env.SEKHA_PORT }}

      - name: Test installation script
        run: |
          chmod +x tests/test_install.sh
          ./tests/test_install.sh
    

      - name: Generate coverage
        run: |
          cargo install cargo-tarpaulin --locked
          cargo tarpaulin --out Xml --output-dir ./coverage --all-features

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/cobertura.xml
          flags: controller-tests
          name: sekha-controller
          fail_ci_if_error: true


  # ============================================================
  # PHASE 2: Test LLM Bridge
  # ============================================================
  test-bridge:
    name: Test LLM Bridge
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout llm-bridge
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/sekha-llm-bridge

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Start Ollama
        run: |
          docker run -d             --name ollama             -p 11434:11434             ollama/ollama:latest
          # Wait for Ollama API
          for i in {1..60}; do
            if curl -f http://localhost:11434/api/tags; then
              echo "Ollama ready"
              break
            fi
            sleep 2
          done

      - name: Pull required models
        run: |
          docker exec ollama ollama pull nomic-embed-text:latest
          docker exec ollama ollama pull llama3.1:8b
          echo "Models ready"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi
          poetry run pip install pytest pytest-cov

      # - name: Lint with flake8
      #  run: |
      #    poetry run flake8 llm_bridge tests --count --select=E9,F63,F7,F82 --show-source --statistics
      #    poetry run flake8 llm_bridge tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests with pytest
        env:
          OLLAMA_HOST: ${{ env.OLLAMA_HOST }}
          REDIS_URL: ${{ env.REDIS_HOST }}
        run: |
          poetry run pytest tests/ -v --cov=llm_bridge --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: llm-bridge-tests
          name: sekha-bridge


  # ============================================================
  # PHASE 3: Integration Test (SDKs + Controller)
  # ============================================================
  integration-test:
    name: Integration Test (SDKs + Controller)
    runs-on: ubuntu-latest
    needs: test-controller
    if: github.event_name == 'schedule'  # Only run nightly

    steps:
      - name: Checkout controller
        uses: actions/checkout@v4
        with:
          path: controller

      - name: Start controller with docker-compose
        working-directory: controller
        run: |
          docker-compose -f docker-compose.yml up -d
          # Wait for controller health
          for i in {1..60}; do
            if curl -f http://localhost:${{ env.SEKHA_PORT }}/health; then
              echo "Controller ready"
              break
            fi
            sleep 2
          done

      - name: Checkout Python SDK
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/python-sdk
          path: python-sdk

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python SDK
        working-directory: python-sdk
        run: |
          pip install -e .
          pip install pytest

      - name: Run integration tests (Python)
        working-directory: python-sdk
        env:
          SEKHA_API_KEY: ${{ env.SEKHA_API_KEY }}
          SEKHA_BASE_URL: http://localhost:${{ env.SEKHA_PORT }}
        run: |
          pytest tests/integration/ -v

      - name: Checkout JavaScript SDK
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/sekha-js-sdk
          path: js-sdk

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: js-sdk/package-lock.json

      - name: Install JS SDK
        working-directory: js-sdk
        run: |
          npm ci
          npm run build

      - name: Run integration tests (JS)
        working-directory: js-sdk
        env:
          SEKHA_API_KEY: ${{ env.SEKHA_API_KEY }}
          SEKHA_BASE_URL: http://localhost:${{ env.SEKHA_PORT }}
        run: |
          npm run test:integration

      - name: Checkout MCP Server
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/sekha-mcp
          path: mcp

      - name: Run MCP integration test
        working-directory: mcp
        env:
          SEKHA_CONTROLLER_URL: http://localhost:${{ env.SEKHA_PORT }}
        run: |
          ./tests/integration.sh

      - name: Cleanup
        working-directory: controller
        run: docker-compose down -v


  # ============================================================
  # PHASE 4: Build & Push (Release)
  # ============================================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: test-controller
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push controller
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/sekha-ai/controller:latest
            ghcr.io/sekha-ai/controller:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push llm-bridge
        uses: docker/build-push-action@v5
        with:
          context: ./llm-bridge
          file: ./llm-bridge/Dockerfile
          push: true
          tags: |
            ghcr.io/sekha-ai/llm-bridge:latest
            ghcr.io/sekha-ai/llm-bridge:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max


  # ============================================================
  # PHASE 5: Quality Gates
  # ============================================================
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [test-controller, test-bridge, integration-test]
    if: always()  # Run even if integration-test is skipped

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit

      - name: Check coverage thresholds
        run: |
          # Controller must have >80% coverage
          # Bridge must have >80% coverage
          # Enforced by codecov settings and badges
          echo "✅ Coverage checks delegated to Codecov"

      - name: Set final status
        run: |
          echo "✅ All quality gates passed"
          exit 0
