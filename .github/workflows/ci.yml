name: CI - Master Orchestrator

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Nightly integration test
    - cron: "0 2 * * *"

env:
  CARGO_TERM_COLOR: always
  SEKHA_PORT: 8080
  CHROMA_HOST: http://localhost:8000
  OLLAMA_HOST: http://localhost:11434
  REDIS_HOST: redis://localhost:6379/0
  SEKHA_API_KEY: "test-token-123-456-789"  # Hardcoded test key
  OLLAMA_MODELS: "nomic-embed-text:latest,llama3.1:8b"

jobs:
  # ============================================================
  # PHASE 1: Start Infrastructure (Chroma, Redis, Ollama)
  # ============================================================
  infrastructure:
    name: Start Test Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Chroma
        run: |
          docker run -d \
            --name chroma \
            -p 8000:8000 \
            chromadb/chroma:latest
          # Wait for Chroma health
          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/heartbeat; then
              echo "Chroma ready"
              break
            fi
            sleep 2
          done

      - name: Start Redis
        run: |
          docker run -d \
            --name redis \
            -p 6379:6379 \
            redis:7-alpine
          # Wait for Redis
          for i in {1..30}; do
            if docker exec redis redis-cli ping; then
              echo "Redis ready"
              break
            fi
            sleep 2
          done

      - name: Start Ollama
        run: |
          docker run -d \
            --name ollama \
            -p 11434:11434 \
            ollama/ollama:latest
          # Wait for Ollama
          for i in {1..60}; do
            if curl -f http://localhost:11434/api/tags; then
              echo "Ollama ready"
              break
            fi
            sleep 2
          done

      - name: Pull required models
        run: |
          docker exec ollama ollama pull nomic-embed-text:latest
          docker exec ollama ollama pull llama3.1:8b
          echo "Models ready"

  # ============================================================
  # PHASE 2: Test Controller
  # ============================================================
  test-controller:
    name: Test Sekha Controller
    runs-on: ubuntu-latest
    needs: infrastructure
    services:
      # Services for matrix testing
      chroma:
        image: chromadb/chroma:latest
        ports:
          - 8000:8000
        options: >-
          --health-cmd="curl -f http://localhost:8000/api/v1/heartbeat"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --all-features --verbose

      - name: Run unit tests
        run: cargo test --lib --all-features --verbose

      - name: Run integration tests
        run: cargo test --test integration_test --all-features --verbose

      - name: Run API tests
        run: cargo test --test api_test --all-features --verbose

      - name: Run 1M message benchmark
        run: cargo test --release --test insert_1m_messages -- --nocapture
        timeout-minutes: 15

      - name: Run E2E smoke test
        run: ./tests/e2e/smoke_test.sh
        env:
          SEKHA_API_KEY: ${{ env.SEKHA_API_KEY }}
          SEKHA_BASE_URL: http://localhost:${{ env.SEKHA_PORT }}

      - name: Generate coverage
        run: |
          cargo install cargo-tarpaulin --version 0.27.0
          cargo tarpaulin --out Xml --output-dir ./coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/cobertura.xml
          flags: controller-tests
          name: sekha-controller

  # ============================================================
  # PHASE 3: Test LLM Bridge
  # ============================================================
  test-bridge:
    name: Test LLM Bridge
    runs-on: ubuntu-latest
    needs: infrastructure
    steps:
      - name: Checkout llm-bridge
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/llm-bridge

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-ansi
          poetry run pip install pytest pytest-cov

      - name: Lint with flake8
        run: |
          poetry run flake8 llm_bridge tests --count --select=E9,F63,F7,F82 --show-source --statistics
          poetry run flake8 llm_bridge tests --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run tests with pytest
        env:
          OLLAMA_HOST: ${{ env.OLLAMA_HOST }}
          REDIS_URL: ${{ env.REDIS_HOST }}
        run: |
          poetry run pytest tests/ -v --cov=llm_bridge --cov-report=xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: llm-bridge-tests
          name: sekha-bridge

  # ============================================================
  # PHASE 4: Integration Test (SDKs + Controller)
  # ============================================================
  integration-test:
    name: Integration Test (SDKs + Controller)
    runs-on: ubuntu-latest
    needs: test-controller
    if: github.event_name == 'schedule'  # Only run nightly

    steps:
      - name: Checkout controller
        uses: actions/checkout@v4

      - name: Start controller with docker-compose
        run: |
          docker-compose -f docker-compose.yml up -d
          # Wait for controller health
          for i in {1..60}; do
            if curl -f http://localhost:${{ env.SEKHA_PORT }}/health; then
              echo "Controller ready"
              break
            fi
            sleep 2
          done

      - name: Test Python SDK against live controller
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/python-sdk

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python SDK
        run: |
          pip install -e .
          pip install pytest

      - name: Run integration tests (Python)
        env:
          SEKHA_API_KEY: ${{ env.SEKHA_API_KEY }}
          SEKHA_BASE_URL: http://localhost:${{ env.SEKHA_PORT }}
        run: |
          pytest tests/integration/ -v

      - name: Test JavaScript SDK against live controller
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/sekha-js-sdk

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install JS SDK
        run: |
          npm ci
          npm run build

      - name: Run integration tests (JS)
        env:
          SEKHA_API_KEY: ${{ env.SEKHA_API_KEY }}
          SEKHA_BASE_URL: http://localhost:${{ env.SEKHA_PORT }}
        run: |
          npm run test:integration

      - name: Test MCP Server
        uses: actions/checkout@v4
        with:
          repository: sekha-ai/sekha-mcp

      - name: Run MCP integration test
        env:
          SEKHA_CONTROLLER_URL: http://localhost:${{ env.SEKHA_PORT }}
        run: |
          ./tests/integration_test.sh

      - name: Cleanup
        run: docker-compose down -v

  # ============================================================
  # PHASE 5: Build & Push (Release)
  # ============================================================
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: test-controller
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push controller
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/sekha-ai/controller:latest
            ghcr.io/sekha-ai/controller:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push llm-bridge
        uses: docker/build-push-action@v5
        with:
          context: ./llm-bridge
          file: ./llm-bridge/Dockerfile
          push: true
          tags: |
            ghcr.io/sekha-ai/llm-bridge:latest
            ghcr.io/sekha-ai/llm-bridge:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # PHASE 6: Quality Gates
  # ============================================================
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [test-controller, test-bridge, integration-test]

    steps:
      - name: Check coverage thresholds
        run: |
          # Controller must have >80% coverage
          # Should fail if below threshold
          echo "Checking coverage..."
          # This would use codecov API or coverage artifacts
          # For now, placeholder that will be enforced by codecov settings

      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit
          # For Python: pip install safety && safety check

      - name: Set final status
        run: |
          echo "âœ… All quality gates passed"
          exit 0